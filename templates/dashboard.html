{% extends "headers.html" %}
{% block content %}

<!-- Main Content -->
<main id="pdf-content">   <!-- ID added for pdf generation -->
  <div class="container">
    <h1>Weather Information</h1>
    <h5><b>Location:</b> <span id="destination-display">{{ travel_data['destination'] if travel_data['destination'] else 'Not specified' }}</span></h5>
    <table id="weather-table" class="table table-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Current Weather Conditions</th>
          <th>Max Temp (째C)</th>
          <th>Min Temp (째C)</th>
          <th>Precipitation Probability</th>
          <th>Humidity</th>
          <th>Weather Alerts</th>
        </tr>
      </thead>
      <tbody id="weather-data">
        {% if travel_data.get('weather') %}
        <tr>
          <td>{{ now.strftime('%Y-%m-%d') }}</td>
          <td>{{ travel_data['weather']['description'] }}</td>
          <td>{{ travel_data['weather']['temp_max'] }}째C</td>
          <td>{{ travel_data['weather']['temp_min'] }}째C</td>
          <td>10%</td> <!-- if available -->
          <td>{{ travel_data['weather']['humidity'] }}%</td>
          <td>No alerts</td> <!-- if available -->
        </tr>
        {% else %}
        <tr>
          <td colspan="7">Weather data not available</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Itinerary Section -->
  <div class="container">
    <h1>Planned Itinerary</h1>
    <p><strong>*This is a tentative itinerary, please be flexible.*</strong></p>

    <div id="itinerary-container">
      {% if travel_data and travel_data.itinerary %}
        <div id="markdown-content" class="itinerary-box">
          {{ travel_data.itinerary | safe }}
        </div>
      {% else %}
        <p>No itinerary generated yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- PDF Download Button -->
  <button id="download" class="btn btn-primary mt-3">Download as PDF</button>

  <!-- Hotel & Flight Booking Section -->
  <div class="container mt-4">
    <h5>
      For Hotels & Flight Booking:
      <a href="https://www.booking.com" target="_blank">
        <button type="button" class="btn btn-light">Click Here</button>
      </a>
    </h5>
  </div>
</main>

<!-- Footer -->
<footer class="jumbotron text-center text-black fixed-bottom" style="background-color: #ffffff;">
  <div class="text-center p-3">
    <p>&copy; {{ now.year }} Copyright</p>
    <p>Made With Love By <a href="#">NextStop</a></p>
  </div>
</footer>

<!-- Styles -->
<style>
  #itinerary-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 5px;
  }
  .itinerary-box {
    white-space: pre-line;
    font-family: Arial, sans-serif;
    font-size: 14px;
    line-height: 1.5;
  }
</style>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it@11.0.1/dist/markdown-it.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const { jsPDF } = window.jspdf;

  // Destination
  let travelData = {};
  try {
    if (typeof sessionStorage !== 'undefined') {
      const storedData = sessionStorage.getItem('travelData');
      travelData = storedData ? JSON.parse(storedData) : {};
    }
  } catch (error) {
    console.error("Error parsing travelData:", error);
    travelData = {};
  }
  document.getElementById('destination-display').textContent = travelData.destination || 'Not specified';

  // Render Markdown in Itinerary
  const markdownIt = window.markdownit();
  const itineraryContainer = document.getElementById('markdown-content');
  if (itineraryContainer) {
    itineraryContainer.innerHTML = markdownIt.render(itineraryContainer.innerHTML);
  }

  // Download PDF
  document.getElementById('download').addEventListener('click', () => {
  const doc = new jsPDF();

  // Title
  doc.setFontSize(22);
  doc.text('Travel Itinerary', 14, 20);

  // Weather Section
  doc.setFontSize(16);
  doc.text('Weather Information', 14, 30);

  // Weather Table
  const weatherTable = document.getElementById('weather-table');
  let finalY = 40;
  
  if (weatherTable) {
    const headers = [];
    weatherTable.querySelectorAll('thead th').forEach(th => headers.push(th.innerText));

    const body = [];
    weatherTable.querySelectorAll('tbody tr').forEach(tr => {
      const row = [];
      tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
      body.push(row);
    });

    doc.autoTable({
      head: [headers],
      body: body,
      startY: finalY,
      styles: { fontSize: 10 },
      margin: { top: 10, bottom: 10, left: 14, right: 14 },
      didDrawPage: (data) => {
        finalY = data.cursor.y;  // Update the Y position after the table
      }
    });
  }

  // Itinerary Section
  if (doc.lastAutoTable) {
    finalY = doc.lastAutoTable.finalY + 10;
  }

  if (finalY + 20 > doc.internal.pageSize.height) {
    doc.addPage();
    finalY = 20;
  }

  doc.setFontSize(16);
  doc.text('Planned Itinerary', 14, finalY);

  const itineraryText = itineraryContainer ? itineraryContainer.innerText : 'No Itinerary Available';

  doc.setFontSize(12);

  const pageHeight = doc.internal.pageSize.height;
  const textY = finalY + 10;
  const lineHeight = 7; // Adjust for your font size
  const maxLineWidth = 180; // Max width before wrapping

  const lines = doc.splitTextToSize(itineraryText, maxLineWidth);
  
  let currentY = textY;

  lines.forEach((line, index) => {
    if (currentY + lineHeight > pageHeight - 20) {
      doc.addPage();
      currentY = 20;
    }
    doc.text(line, 14, currentY);
    currentY += lineHeight;
  });

  // Save PDF
  doc.save('travel-itinerary.pdf');
});

});
</script>

{% endblock %}
